services:
  # Ghidra Server - Main analysis backend
  ghidra-server:
    image: blacktop/ghidra:latest
    container_name: ghidra-server
    command: server
    ports:
      - ${GHIDRA_PORT:-13100}:13100 # Ghidra server port
      - ${GHIDRA_PORT_RANGE_START:-13101}:13101
      - ${GHIDRA_PORT_RANGE_END:-13102}:13102
    volumes:
      - ${REPO_DATA_PATH:-./repo-data}:/repos
      - ./config/server.conf:/ghidra/server/server.conf:ro
    environment:
      - JVM_OPTS=-Xmx${JVM_MAX_MEMORY:-4g}
      - GHIDRA_IP=${GHIDRA_IP:-localhost}
      - GHIDRA_USERS=${GHIDRA_USERS:-admin}
    networks:
      - backend
    restart: unless-stopped

  # PostgreSQL database for BSim functionality with lshvector extension
  # Built from custom Dockerfile that includes Ghidra's lshvector extension
  bsim-postgres:
    build:
      context: .
      dockerfile: docker/Dockerfile.bsim-postgres
    image: bsim-postgres:fixed
    container_name: bsim-postgres
    environment:
      - POSTGRES_DB=${BSIM_DB_NAME:-bsim}
      - POSTGRES_USER=${BSIM_DB_USER:-ben}
      - POSTGRES_PASSWORD=${BSIM_DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
      - AUTO_CREATE_BSIM_SCHEMA=${AUTO_CREATE_BSIM_SCHEMA:-true}
    ports:
      - "${BSIM_DB_PORT:-5432}:5432"
    volumes:
      - bsim_postgres_data:/var/lib/postgresql/data
    command: >
      postgres
      -c password_encryption=scram-sha-256
      -c log_statement=all
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c work_mem=16MB
      -c random_page_cost=1.1
      -c effective_io_concurrency=4
      -c checkpoint_timeout=15min
      -c log_min_duration_statement=1000
      -c log_checkpoints=on
      -c log_lock_waits=on
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
    networks:
      - backend
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${BSIM_DB_USER:-ben} -d ${BSIM_DB_NAME:-bsim}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache Service
  redis-cache:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ret-sync relay server (placeholder for future implementation)
  ret-sync-relay:
    image: alpine:latest
    container_name: ret-sync-relay
    command: sleep infinity # Placeholder - will be replaced with actual ret-sync server
    ports:
      - "${RETSYNC_PORT:-9100}:9100" # ret-sync default port
    volumes:
      - ${SYNC_LOGS_PATH:-./sync-logs}:/sync-logs
    depends_on:
      - ghidra-server
      - bsim-postgres
    networks:
      - backend
    restart: unless-stopped

  # Django Web Application - RE Platform Dashboard
  ghidra-web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    image: ghidra-web:latest
    container_name: ghidra-web
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-change-me-in-production}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-False}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DJANGO_USE_X_FORWARDED_HOST=${DJANGO_USE_X_FORWARDED_HOST:-False}
      - DJANGO_USE_X_FORWARDED_PORT=${DJANGO_USE_X_FORWARDED_PORT:-False}
      - DJANGO_SECURE_PROXY_SSL_HEADER=${DJANGO_SECURE_PROXY_SSL_HEADER:-False}
      - DJANGO_CSRF_TRUSTED_ORIGINS=${DJANGO_CSRF_TRUSTED_ORIGINS:-}
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
    ports:
      - "8083:80" # Temporary port mapping for verification
    depends_on:
      bsim-postgres:
        condition: service_healthy
    networks:
      - backend
      - proxy
    labels:
      # Traefik Configuration (enable by setting TRAEFIK_ENABLE=true in .env)
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      # HTTPS router
      - "traefik.http.routers.d2docs.rule=Host(`d2docs.xebyte.us`) || Host(`d2docs.xebyte.com`)"
      - "traefik.http.routers.d2docs.entrypoints=websecure"
      - "traefik.http.routers.d2docs.tls.certresolver=le"
      - "traefik.http.routers.d2docs.tls.domains[0].main=d2docs.xebyte.us"
      - "traefik.http.routers.d2docs.tls.domains[1].main=d2docs.xebyte.com"
      - "traefik.http.services.d2docs.loadbalancer.server.port=80"
      # HTTP router with redirect
      - "traefik.http.routers.d2docs-http.rule=Host(`d2docs.xebyte.us`) || Host(`d2docs.xebyte.com`)"
      - "traefik.http.routers.d2docs-http.entrypoints=web"
      - "traefik.http.routers.d2docs-http.middlewares=redirect-to-https@file"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1:80/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Spring Boot API - Ghidra Analysis API
  ghidra-api:
    image: spring-api-enhanced:latest
    container_name: ghidra-api
    ports:
      - "${GHIDRA_API_PORT:-8081}:8080"
    environment:
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - GHIDRA_SERVER_HOST=10.0.10.30
      - GHIDRA_SERVER_PORT=13100
      - GHIDRA_PROJECTS_PATH=/repos
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
    volumes:
      - ${REPO_DATA_PATH:-./repo-data}:/repos:ro
    depends_on:
      - ghidra-server
      - bsim-postgres
      - redis-cache
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      # HTTPS router
      - "traefik.http.routers.d2api.rule=Host(`api.xebyte.us`) || Host(`api.xebyte.com`)"
      - "traefik.http.routers.d2api.entrypoints=websecure"
      - "traefik.http.routers.d2api.tls.certresolver=le"
      - "traefik.http.routers.d2api.tls.domains[0].main=api.xebyte.us"
      - "traefik.http.routers.d2api.tls.domains[1].main=api.xebyte.com"
      - "traefik.http.services.d2api.loadbalancer.server.port=8080"
      # HTTP router with redirect
      - "traefik.http.routers.d2api-http.rule=Host(`api.xebyte.us`) || Host(`api.xebyte.com`)"
      - "traefik.http.routers.d2api-http.entrypoints=web"
      - "traefik.http.routers.d2api-http.middlewares=redirect-to-https@file"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Vector Search Service - Semantic Search with pgvector
  # Provides embedding generation and similarity search for functions
  vector-search:
    build:
      context: ./services/vector-search
      dockerfile: Dockerfile
    image: vector-search:latest
    container_name: vector-search
    ports:
      - "${VECTOR_SEARCH_PORT:-8091}:8090"
    env_file:
      - .env
    environment:
      - VECTOR_SEARCH_HOST=${VECTOR_SEARCH_HOST:-vector-search}
      - VECTOR_SEARCH_PORT=8090
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - VECTOR_DIMENSION=${VECTOR_DIMENSION:-1536}
      - VECTOR_SIMILARITY_THRESHOLD=${VECTOR_SIMILARITY_THRESHOLD:-0.7}
      - VECTOR_MAX_RESULTS=${VECTOR_MAX_RESULTS:-20}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-False}
    depends_on:
      bsim-postgres:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    networks:
      - backend
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # GhidraMCP - AI-Powered Analysis Interface (MCP Server)
  # Provides 144 REST endpoints for AI-assisted reverse engineering
  # Submodule: ./ghidra-mcp (github.com/bethington/ghidra-mcp)
  ghidra-mcp:
    build:
      context: ./ghidra-mcp
      dockerfile: docker/Dockerfile
    image: ghidra-mcp-headless:latest
    container_name: ghidra-mcp
    ports:
      - "${GHIDRA_MCP_PORT:-8089}:8089"
    environment:
      - GHIDRA_MCP_PORT=8089
      - GHIDRA_MCP_BIND_ADDRESS=0.0.0.0
      - JAVA_OPTS=-Xmx8g -XX:+UseG1GC
      - GHIDRA_SERVER_HOST=10.0.10.30
      - GHIDRA_SERVER_PORT=13100
      - GHIDRA_SERVER_USER=ghidra-mcp
      - GHIDRA_DEFAULT_REPOSITORY=pd2
      - GHIDRA_SERVER_PASSWORD=ghidra-mcp-pass123
    volumes:
      - ./binaries:/data:ro
      - ghidra_mcp_projects:/projects
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.ghidra-mcp.rule=Host(`mcp.xebyte.com`)"
      - "traefik.http.routers.ghidra-mcp.entrypoints=websecure"
      - "traefik.http.routers.ghidra-mcp.tls.certresolver=le"
      - "traefik.http.services.ghidra-mcp.loadbalancer.server.port=8089"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  # AI Orchestration Service - Multi-Model Intelligence Coordination
  # Provides intelligent routing, cost controls, and orchestration across AI models
  ai-orchestration:
    build:
      context: ./services/ai-orchestration
      dockerfile: Dockerfile
    image: ai-orchestration:latest
    container_name: ai-orchestration
    ports:
      - "${AI_ORCHESTRATION_PORT:-8092}:8092"
    env_file:
      - .env
    environment:
      - AI_ORCHESTRATION_HOST=${AI_ORCHESTRATION_HOST:-ai-orchestration}
      - AI_ORCHESTRATION_PORT=8092
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - REDIS_DB=1
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DAILY_BUDGET=${DAILY_BUDGET:-50.0}
      - WARNING_THRESHOLD=${WARNING_THRESHOLD:-0.80}
      - CRITICAL_THRESHOLD=${CRITICAL_THRESHOLD:-0.95}
      - EMERGENCY_THRESHOLD=${EMERGENCY_THRESHOLD:-1.00}
      - ENABLE_MODEL_ROUTING=${ENABLE_MODEL_ROUTING:-true}
      - VECTOR_SEARCH_URL=http://vector-search:8090
      - GHIDRA_MCP_URL=http://ghidra-mcp:8089
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-False}
    depends_on:
      redis-cache:
        condition: service_healthy
      vector-search:
        condition: service_healthy
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Chat Interface Service - Real-time AI Chat with User Feedback
  # Provides WebSocket-based chat interface with AI orchestration integration
  chat-interface:
    build:
      context: ./services/chat-interface
      dockerfile: Dockerfile
    image: chat-interface:latest
    container_name: chat-interface
    ports:
      - "${CHAT_INTERFACE_PORT:-8093}:8093"
    env_file:
      - .env
    environment:
      - CHAT_INTERFACE_HOST=${CHAT_INTERFACE_HOST:-chat-interface}
      - CHAT_INTERFACE_PORT=8093
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - AI_ORCHESTRATION_URL=http://ai-orchestration:8092
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      - MAX_CONVERSATION_HISTORY=100
      - RATE_LIMIT_REQUESTS=100
      - WEBSOCKET_MAX_CONNECTIONS=1000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-False}
    depends_on:
      bsim-postgres:
        condition: service_healthy
      ai-orchestration:
        condition: service_healthy
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.chat-interface.rule=Host(`chat.d2docs.xebyte.com`) || Host(`chat.d2docs.xebyte.us`)"
      - "traefik.http.routers.chat-interface.entrypoints=websecure"
      - "traefik.http.routers.chat-interface.tls.certresolver=le"
      - "traefik.http.services.chat-interface.loadbalancer.server.port=8093"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8093/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # GitHub Mining Service - Community Knowledge Discovery
  # Provides intelligent repository discovery and quality assessment
  github-mining:
    build:
      context: ./services/github-mining
      dockerfile: Dockerfile
    image: github-mining:latest
    container_name: github-mining
    ports:
      - "${GITHUB_MINING_PORT:-8094}:8094"
    env_file:
      - .env
    environment:
      - GITHUB_MINING_HOST=${GITHUB_MINING_HOST:-github-mining}
      - GITHUB_MINING_PORT=8094
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - REDIS_DB=2
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITHUB_REQUESTS_PER_HOUR=${GITHUB_REQUESTS_PER_HOUR:-1000}
      - MIN_REPOSITORY_STARS=${MIN_REPOSITORY_STARS:-5}
      - MIN_RELEVANCE_SCORE=${MIN_RELEVANCE_SCORE:-0.3}
      - MIN_QUALITY_SCORE=${MIN_QUALITY_SCORE:-40.0}
      - MAX_REPOSITORY_SIZE_MB=${MAX_REPOSITORY_SIZE_MB:-200}
      - CONCURRENT_MINING_TASKS=${CONCURRENT_MINING_TASKS:-5}
      - DISCOVERY_INTERVAL_HOURS=${DISCOVERY_INTERVAL_HOURS:-6}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-False}
    depends_on:
      bsim-postgres:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.http.routers.github-mining.rule=Host(`mining.xebyte.com`)"
      - "traefik.http.routers.github-mining.entrypoints=websecure"
      - "traefik.http.routers.github-mining.tls.certresolver=le"
      - "traefik.http.services.github-mining.loadbalancer.server.port=8094"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Knowledge Integration Service
  knowledge-integration:
    build:
      context: ./services/knowledge-integration
      dockerfile: Dockerfile
    image: knowledge-integration:latest
    container_name: knowledge-integration
    ports:
      - "${KNOWLEDGE_INTEGRATION_PORT:-8095}:8095"
    env_file:
      - .env
    environment:
      - KNOWLEDGE_INTEGRATION_HOST=${KNOWLEDGE_INTEGRATION_HOST:-knowledge-integration}
      - KNOWLEDGE_INTEGRATION_PORT=8095
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
    depends_on:
      bsim-postgres:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      github-mining:
        condition: service_healthy
    networks:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.knowledge-integration.rule=Host(`knowledge.xebyte.com`)"
      - "traefik.http.routers.knowledge-integration.entrypoints=websecure"
      - "traefik.http.routers.knowledge-integration.tls.certresolver=le"
      - "traefik.http.services.knowledge-integration.loadbalancer.server.port=8095"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Monitoring Dashboard Service
  monitoring-dashboard:
    build:
      context: ./services/monitoring-dashboard
      dockerfile: Dockerfile
    image: monitoring-dashboard:latest
    container_name: monitoring-dashboard
    ports:
      - "${MONITORING_DASHBOARD_PORT:-8096}:8096"
    env_file:
      - .env
    environment:
      - MONITORING_DASHBOARD_HOST=${MONITORING_DASHBOARD_HOST:-monitoring-dashboard}
      - MONITORING_DASHBOARD_PORT=8096
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
    depends_on:
      bsim-postgres:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.monitoring-dashboard.rule=Host(`monitor.d2docs.xebyte.com`) || Host(`monitor.d2docs.xebyte.us`)"
      - "traefik.http.routers.monitoring-dashboard.entrypoints=websecure"
      - "traefik.http.routers.monitoring-dashboard.tls.certresolver=le"
      - "traefik.http.services.monitoring-dashboard.loadbalancer.server.port=8096"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

volumes:
  bsim_postgres_data:
  redis_data:
  ghidra_mcp_projects:

networks:
  backend:
  proxy:
    external: true
    name: proxy
