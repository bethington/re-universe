services:
  # Ghidra Server - Main analysis backend
  ghidra-server:
    image: blacktop/ghidra:latest
    container_name: ghidra-server
    command: server
    ports:
      - ${GHIDRA_PORT:-13100}:13100  # Ghidra server port
      - ${GHIDRA_PORT_RANGE_START:-13101}:13101
      - ${GHIDRA_PORT_RANGE_END:-13102}:13102
    volumes:
      - ${REPO_DATA_PATH:-./repo-data}:/repos
    environment:
      - JVM_OPTS=-Xmx${JVM_MAX_MEMORY:-4g}
      - GHIDRA_IP=${GHIDRA_IP:-localhost}
      - GHIDRA_USERS=${GHIDRA_USERS:-admin}
    networks:
      - backend

  # PostgreSQL database for BSim functionality
  # This provides the database backend that will be used by Ghidra BSim tools
  bsim-postgres:
    image: postgres:15
    container_name: bsim-postgres
    environment:
      - POSTGRES_DB=${BSIM_DB_NAME:-bsim}
      - POSTGRES_USER=${BSIM_DB_USER:-ben}
      - POSTGRES_PASSWORD=${BSIM_DB_PASSWORD:-***REMOVED***}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
    ports:
      - "${BSIM_DB_PORT:-5432}:5432"
    volumes:
      - bsim_postgres_data:/var/lib/postgresql/data
    command: >
      postgres
      -c password_encryption=scram-sha-256
      -c log_statement=all
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${BSIM_DB_USER:-ben} -d ${BSIM_DB_NAME:-bsim}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ret-sync relay server (placeholder for future implementation)
  ret-sync-relay:
    image: alpine:latest
    container_name: ret-sync-relay
    command: sleep infinity  # Placeholder - will be replaced with actual ret-sync server
    ports:
      - "${RETSYNC_PORT:-9100}:9100"   # ret-sync default port
    volumes:
      - ${SYNC_LOGS_PATH:-./sync-logs}:/sync-logs
    depends_on:
      - ghidra-server
      - bsim-postgres
    networks:
      - backend

volumes:
  bsim_postgres_data:

networks:
  backend:
