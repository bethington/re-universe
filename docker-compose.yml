services:
  # Ghidra Server - Main analysis backend
  ghidra-server:
    image: blacktop/ghidra:latest
    container_name: ghidra-server
    command: server
    ports:
      - ${GHIDRA_PORT:-13100}:13100 # Ghidra server port
      - ${GHIDRA_PORT_RANGE_START:-13101}:13101
      - ${GHIDRA_PORT_RANGE_END:-13102}:13102
    volumes:
      - ${REPO_DATA_PATH:-./repo-data}:/repos
    environment:
      - JVM_OPTS=-Xmx${JVM_MAX_MEMORY:-4g}
      - GHIDRA_IP=${GHIDRA_IP:-localhost}
      - GHIDRA_USERS=${GHIDRA_USERS:-admin}
    networks:
      - backend

  # PostgreSQL database for BSim functionality with lshvector extension
  # Built from custom Dockerfile that includes Ghidra's lshvector extension
  bsim-postgres:
    build:
      context: ./bsim-postgres
      dockerfile: Dockerfile
    image: bsim-postgres:15-lshvector
    container_name: bsim-postgres
    environment:
      - POSTGRES_DB=${BSIM_DB_NAME:-bsim}
      - POSTGRES_USER=${BSIM_DB_USER:-ben}
      - POSTGRES_PASSWORD=${BSIM_DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
      - AUTO_CREATE_BSIM_SCHEMA=${AUTO_CREATE_BSIM_SCHEMA:-true}
    ports:
      - "${BSIM_DB_PORT:-5432}:5432"
    volumes:
      - bsim_postgres_data:/var/lib/postgresql/data
    command: >
      postgres
      -c password_encryption=scram-sha-256
      -c log_statement=all
      -c log_line_prefix='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c work_mem=16MB
      -c random_page_cost=1.1
      -c effective_io_concurrency=4
      -c checkpoint_timeout=15min
      -c log_min_duration_statement=1000
      -c log_checkpoints=on
      -c log_lock_waits=on
      -c ssl=on
    networks:
      - backend
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${BSIM_DB_USER:-ben} -d ${BSIM_DB_NAME:-bsim}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache Service
  redis-cache:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ret-sync relay server (placeholder for future implementation)
  ret-sync-relay:
    image: alpine:latest
    container_name: ret-sync-relay
    command: sleep infinity # Placeholder - will be replaced with actual ret-sync server
    ports:
      - "${RETSYNC_PORT:-9100}:9100" # ret-sync default port
    volumes:
      - ${SYNC_LOGS_PATH:-./sync-logs}:/sync-logs
    depends_on:
      - ghidra-server
      - bsim-postgres
    networks:
      - backend

  # Django Web Application - RE Platform Dashboard
  ghidra-web:
    build:
      context: ./web
      dockerfile: Dockerfile
    image: ghidra-web:latest
    container_name: ghidra-web
    environment:
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-change-me-in-production}
      - DJANGO_DEBUG=${DJANGO_DEBUG:-False}
      - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DJANGO_USE_X_FORWARDED_HOST=${DJANGO_USE_X_FORWARDED_HOST:-False}
      - DJANGO_USE_X_FORWARDED_PORT=${DJANGO_USE_X_FORWARDED_PORT:-False}
      - DJANGO_SECURE_PROXY_SSL_HEADER=${DJANGO_SECURE_PROXY_SSL_HEADER:-False}
      - DJANGO_CSRF_TRUSTED_ORIGINS=${DJANGO_CSRF_TRUSTED_ORIGINS:-}
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
    depends_on:
      bsim-postgres:
        condition: service_healthy
    networks:
      - backend
      - proxy
    labels:
      # Traefik Configuration (enable by setting TRAEFIK_ENABLE=true in .env)
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      # HTTPS router
      - "traefik.http.routers.d2docs.rule=Host(`d2docs.xebyte.us`) || Host(`d2docs.xebyte.com`)"
      - "traefik.http.routers.d2docs.entrypoints=websecure"
      - "traefik.http.routers.d2docs.tls.certresolver=le"
      - "traefik.http.routers.d2docs.tls.domains[0].main=d2docs.xebyte.us"
      - "traefik.http.routers.d2docs.tls.domains[1].main=d2docs.xebyte.com"
      - "traefik.http.services.d2docs.loadbalancer.server.port=80"
      # HTTP router with redirect
      - "traefik.http.routers.d2docs-http.rule=Host(`d2docs.xebyte.us`) || Host(`d2docs.xebyte.com`)"
      - "traefik.http.routers.d2docs-http.entrypoints=web"
      - "traefik.http.routers.d2docs-http.middlewares=redirect-to-https@file"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1:80/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Spring Boot API - Ghidra Analysis API
  ghidra-api:
    build:
      context: ./websites/spring-api
      dockerfile: Dockerfile
    image: ghidra-api:latest
    container_name: ghidra-api
    ports:
      - "${GHIDRA_API_PORT:-8081}:8080"
    environment:
      - BSIM_DB_HOST=bsim-postgres
      - BSIM_DB_PORT=5432
      - BSIM_DB_NAME=${BSIM_DB_NAME:-bsim}
      - BSIM_DB_USER=${BSIM_DB_USER:-ben}
      - BSIM_DB_PASSWORD=${BSIM_DB_PASSWORD}
      - GHIDRA_SERVER_HOST=ghidra-server
      - GHIDRA_SERVER_PORT=13100
      - GHIDRA_PROJECTS_PATH=/repos
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
    volumes:
      - ${REPO_DATA_PATH:-./repo-data}:/repos:ro
    depends_on:
      - ghidra-server
      - bsim-postgres
      - redis-cache
    networks:
      - backend
      - proxy
    labels:
      - "traefik.enable=${TRAEFIK_ENABLE:-false}"
      # HTTPS router
      - "traefik.http.routers.d2api.rule=Host(`api.xebyte.us`) || Host(`api.xebyte.com`)"
      - "traefik.http.routers.d2api.entrypoints=websecure"
      - "traefik.http.routers.d2api.tls.certresolver=le"
      - "traefik.http.routers.d2api.tls.domains[0].main=api.xebyte.us"
      - "traefik.http.routers.d2api.tls.domains[1].main=api.xebyte.com"
      - "traefik.http.services.d2api.loadbalancer.server.port=8080"
      # HTTP router with redirect
      - "traefik.http.routers.d2api-http.rule=Host(`api.xebyte.us`) || Host(`api.xebyte.com`)"
      - "traefik.http.routers.d2api-http.entrypoints=web"
      - "traefik.http.routers.d2api-http.middlewares=redirect-to-https@file"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s


volumes:
  bsim_postgres_data:
  redis_data:

networks:
  backend:
  proxy:
    external: true
    name: proxy
