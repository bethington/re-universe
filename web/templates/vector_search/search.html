{% extends "vector_search/base.html" %}

{% block title %}Vector Search - D2Docs{% endblock %}

{% block content %}
<div class="vector-search-container">
    <div class="page-header">
        <h1>Function Semantic Search</h1>
        <p class="lead">Search for functions using natural language descriptions and find similar code patterns</p>

        {% if vector_search_status %}
        <div class="status-indicator {% if vector_search_available %}status-healthy{% else %}status-unhealthy{% endif %}">
            <span>●</span>
            Vector Search: {% if vector_search_available %}Available{% else %}Unavailable{% endif %}
        </div>
        {% endif %}
    </div>

    {% if not vector_search_available %}
    <div class="error-message">
        <h4>Vector Search Service Unavailable</h4>
        <p>The semantic search functionality is currently not available. This could be due to:</p>
        <ul>
            <li>Service is starting up (please wait a moment and refresh)</li>
            <li>Database connection issues</li>
            <li>Missing embeddings (functions need to be processed first)</li>
        </ul>
        <p><a href="{% url 'vector_search:status' %}">Check service status →</a></p>
    </div>
    {% else %}

    <form id="search-form" class="search-form">
        <div class="form-group">
            <label for="search-input">Search Query</label>
            <input
                type="text"
                id="search-input"
                name="query"
                class="search-input"
                placeholder="e.g., 'function that handles inventory management', 'skill tree calculation', 'network packet processing'"
                required
                autocomplete="off"
            />
        </div>

        <div class="search-options">
            <label>
                Max Results:
                <input type="number" name="limit" value="20" min="1" max="100" />
            </label>

            <label>
                Similarity Threshold:
                <input type="range" name="threshold" min="0.1" max="1.0" step="0.1" value="0.7"
                       oninput="this.nextElementSibling.textContent = (this.value * 100).toFixed(0) + '%'" />
                <span>70%</span>
            </label>

            <label>
                <input type="checkbox" name="use_cache" checked />
                Use cached results
            </label>

            <button type="submit" id="search-button" class="btn-search">Search</button>
        </div>
    </form>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
        <div class="loading-spinner"></div>
        <p>Searching for similar functions...</p>
    </div>

    <!-- Results container -->
    <div id="results-container"></div>

    {% if metrics %}
    <div class="search-stats" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h3>Search Statistics</h3>
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
            <div class="stat-item">
                <div class="stat-value" style="font-size: 24px; font-weight: bold; color: #007bff;">
                    {{ metrics.total_functions|default:"0" }}
                </div>
                <div class="stat-label" style="color: #6c757d;">Total Functions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="font-size: 24px; font-weight: bold; color: #28a745;">
                    {{ metrics.functions_with_embeddings|default:"0" }}
                </div>
                <div class="stat-label" style="color: #6c757d;">Functions with Embeddings</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="font-size: 24px; font-weight: bold; color: #ffc107;">
                    {{ metrics.embedding_coverage_percent|default:"0" }}%
                </div>
                <div class="stat-label" style="color: #6c757d;">Coverage</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="font-size: 24px; font-weight: bold; color: #17a2b8;">
                    {{ metrics.avg_search_time_ms|default:"0" }}ms
                </div>
                <div class="stat-label" style="color: #6c757d;">Avg Search Time</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Help section -->
    <div style="margin-top: 40px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
        <h3>Search Tips</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
            <div>
                <h4>Natural Language Queries</h4>
                <ul>
                    <li>"function that manages player inventory"</li>
                    <li>"skill calculation and damage formulas"</li>
                    <li>"network message handling"</li>
                    <li>"item generation and properties"</li>
                </ul>
            </div>
            <div>
                <h4>Technical Searches</h4>
                <ul>
                    <li>"memory allocation and cleanup"</li>
                    <li>"file I/O and data persistence"</li>
                    <li>"graphics rendering pipeline"</li>
                    <li>"AI and pathfinding algorithms"</li>
                </ul>
            </div>
        </div>
        <p style="margin-top: 15px; font-size: 14px; color: #6c757d;">
            The similarity threshold controls how closely functions must match your query.
            Lower values (30-50%) find more broadly related functions, while higher values (70-90%)
            find very specific matches.
        </p>
    </div>

    {% endif %}
</div>
{% endblock %}