<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Version Function Matrix</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            padding: 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 500;
            font-size: 14px;
            color: #34495e;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }

        .matrix-container {
            display: flex;
            height: 600px;
            overflow: hidden;
        }

        .function-list {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .function-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            font-family: monospace;
            font-size: 12px;
        }

        .function-item:hover {
            background: #e3f2fd;
        }

        .function-item.selected {
            background: #d0e7ff;
            border-left: 3px solid #6969FE;
            font-weight: 500;
        }

        .function-item.library {
            color: #6c757d;
            font-style: italic;
        }

        .function-item .function-name {
            font-weight: 500;
        }

        .function-item .function-address {
            color: #6c757d;
            font-size: 11px;
        }

        .function-item .function-tags {
            margin-top: 2px;
            font-size: 10px;
        }

        .tag {
            display: inline-block;
            padding: 1px 4px;
            margin-right: 3px;
            background: #e9ecef;
            border-radius: 2px;
            font-size: 9px;
            color: #495057;
        }

        .tag.game-logic { background: #d4edda; color: #155724; }
        .tag.library { background: #f8d7da; color: #721c24; }
        .tag.utility { background: #d1ecf1; color: #0c5460; }
        .tag.mod { background: #fff3cd; color: #856404; }

        .matrix-scroll {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .matrix-table {
            min-width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .matrix-table th {
            background: #6969FE;
            color: white;
            padding: 8px 4px;
            font-size: 11px;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            min-width: 40px;
            max-width: 80px;
        }

        .matrix-table th.selected-version {
            background: #4a4af0;
            font-weight: 700;
        }

        .matrix-table td {
            padding: 3px;
            text-align: center;
            border: 1px solid #e9ecef;
            min-width: 40px;
            cursor: pointer;
            position: relative;
        }

        .matrix-table tr.selected-row td {
            background-color: #e6f3ff;
        }

        .matrix-table td.selected-version {
            color: #6969FE;
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .matrix-table td.bullseye {
            background-color: #d0e7ff !important;
            border: 2px solid #6969FE;
            font-weight: bold;
        }

        .similarity-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            font-weight: 500;
        }

        .exact-match { color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        .similar-match { color: #ff6600; background: rgba(255, 102, 0, 0.1); }
        .weak-match { color: #999999; background: rgba(153, 153, 153, 0.1); }
        .no-match { color: #cccccc; }

        .compare-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .compare-panel.visible {
            display: block;
        }

        .compare-header {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }

        .compare-content {
            padding: 20px;
        }

        .function-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .function-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }

        .function-details h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .detail-item {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
        }

        .similarity-metrics {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .metric-score {
            font-weight: 500;
            color: #2c3e50;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .status {
            padding: 10px 20px;
            background: #d4edda;
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        @media (max-width: 1200px) {
            .compare-panel {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cross-Version Function Matrix</h1>
            <p>Interactive similarity analysis across Diablo 2 versions with enhanced tagging and comparison</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="versionSelect">Version</label>
                <select id="versionSelect">
                    <option value="">Select Version...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="binarySelect">Binary</label>
                <select id="binarySelect">
                    <option value="">Select Binary...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="filterInput">Filter Functions</label>
                <input type="text" id="filterInput" placeholder="Search functions...">
            </div>
            <div class="control-group">
                <label for="tagFilter">Filter by Tag</label>
                <select id="tagFilter">
                    <option value="">All Functions</option>
                    <option value="GAME_LOGIC">Game Logic</option>
                    <option value="LIBRARY">Library Functions</option>
                    <option value="UTILITY">Utility Functions</option>
                    <option value="MOD">Mod-Relevant</option>
                </select>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="matrix-container">
            <div class="function-list" id="functionList">
                <div class="loading">Select a version and binary to load functions</div>
            </div>
            <div class="matrix-scroll">
                <table class="matrix-table" id="matrixTable">
                    <thead id="matrixHeader"></thead>
                    <tbody id="matrixBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="compare-panel" id="comparePanel">
        <div class="compare-header">
            <h3>Function Comparison</h3>
            <button class="close-btn" onclick="closeComparePanel()">Ã—</button>
        </div>
        <div class="compare-content" id="compareContent">
            <div class="loading">Select a function to compare</div>
        </div>
    </div>

    <script>
        // Global state
        let currentData = {
            versions: [],
            binaries: [],
            functions: [],
            selectedVersion: null,
            selectedBinary: null,
            selectedFunction: null,
            selectedTargetAddress: null,
            matrix: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadVersions();
        });

        function initializeEventListeners() {
            document.getElementById('versionSelect').addEventListener('change', onVersionChange);
            document.getElementById('binarySelect').addEventListener('change', onBinaryChange);
            document.getElementById('filterInput').addEventListener('input', onFilterChange);
            document.getElementById('tagFilter').addEventListener('change', onTagFilterChange);
        }

        async function loadVersions() {
            // Mock data - in real implementation, this would call the Java API
            currentData.versions = [
                { version: "1.01", family: "Classic", binaryCount: 5 },
                { version: "1.03", family: "Classic", binaryCount: 6 },
                { version: "1.07", family: "LoD", binaryCount: 8 },
                { version: "1.13c", family: "LoD", binaryCount: 10 },
                { version: "1.13c-PD2", family: "PD2", binaryCount: 12 }
            ];

            const versionSelect = document.getElementById('versionSelect');
            versionSelect.innerHTML = '<option value="">Select Version...</option>';

            currentData.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.version;
                option.textContent = `${version.family} ${version.version} (${version.binaryCount} binaries)`;
                versionSelect.appendChild(option);
            });
        }

        async function onVersionChange(event) {
            const selectedVersion = event.target.value;
            currentData.selectedVersion = selectedVersion;

            if (selectedVersion) {
                await loadBinaries(selectedVersion);
            } else {
                clearBinaries();
            }
        }

        async function loadBinaries(version) {
            // Mock data - in real implementation, this would call the Java API
            const mockBinaries = {
                "1.01": [
                    { id: 1, binaryName: "Game.exe", family: "Classic", functionCount: 2543 },
                    { id: 2, binaryName: "D2Client.dll", family: "Classic", functionCount: 1876 }
                ],
                "1.13c": [
                    { id: 10, binaryName: "Game.exe", family: "LoD", functionCount: 3421 },
                    { id: 11, binaryName: "D2Game.dll", family: "LoD", functionCount: 2103 }
                ],
                "1.13c-PD2": [
                    { id: 20, binaryName: "Game.exe", family: "PD2", functionCount: 3654 },
                    { id: 21, binaryName: "D2Game.dll", family: "PD2", functionCount: 2298 }
                ]
            };

            currentData.binaries = mockBinaries[version] || [];

            const binarySelect = document.getElementById('binarySelect');
            binarySelect.innerHTML = '<option value="">Select Binary...</option>';

            currentData.binaries.forEach(binary => {
                const option = document.createElement('option');
                option.value = binary.binaryName;
                option.textContent = `${binary.binaryName} (${binary.functionCount} functions)`;
                binarySelect.appendChild(option);
            });
        }

        function clearBinaries() {
            document.getElementById('binarySelect').innerHTML = '<option value="">Select Binary...</option>';
            clearFunctionList();
        }

        async function onBinaryChange(event) {
            const selectedBinary = event.target.value;
            currentData.selectedBinary = selectedBinary;

            if (selectedBinary && currentData.selectedVersion) {
                await loadFunctionMatrix(currentData.selectedVersion, selectedBinary);
            } else {
                clearFunctionList();
            }
        }

        async function loadFunctionMatrix(version, binary) {
            showStatus(`Loading function matrix for ${binary} (${version})...`);

            // Mock function data with comprehensive tagging
            currentData.functions = generateMockFunctions();
            currentData.matrix = generateMockMatrix();

            renderFunctionList();
            renderMatrixTable();

            hideStatus();
        }

        function generateMockFunctions() {
            const functionTypes = ['Game', 'Player', 'Item', 'Combat', 'Network', 'UI', 'Library'];
            const tags = [
                'GAME_LOGIC_PLAYER', 'GAME_LOGIC_COMBAT', 'GAME_LOGIC_ITEMS',
                'LIBRARY_WINDOWS_API', 'UTILITY_STRING', 'MOD_HOOKABLE',
                'COMPLEXITY_MODERATE', 'FUNCTION_LEAF'
            ];

            return Array.from({ length: 50 }, (_, i) => ({
                id: i + 1,
                name: `${functionTypes[i % functionTypes.length]}Function_${String(i + 1).padStart(3, '0')}`,
                address: `0x${(0x401000 + i * 0x100).toString(16).toUpperCase()}`,
                isLibrary: i % 7 === 0,
                complexity: Math.floor(Math.random() * 10) + 1,
                tags: tags.slice(0, Math.floor(Math.random() * 4) + 1)
            }));
        }

        function generateMockMatrix() {
            const versions = ["1.01", "1.03", "1.07", "1.13c", "1.13c-PD2"];
            const matrix = {};

            currentData.functions.forEach(func => {
                const funcKey = `${func.name}@${func.address}`;
                matrix[funcKey] = {};

                versions.forEach(version => {
                    const similarity = Math.random();
                    if (similarity > 0.3) {
                        matrix[funcKey][version] = {
                            score: similarity,
                            matchType: similarity > 0.95 ? 'EXACT' : similarity > 0.7 ? 'SIMILAR' : 'WEAK',
                            confidence: similarity > 0.8 ? 'HIGH' : similarity > 0.5 ? 'MEDIUM' : 'LOW',
                            targetBinary: 'D2Game.dll'
                        };
                    }
                });
            });

            return matrix;
        }

        function renderFunctionList() {
            const functionList = document.getElementById('functionList');
            functionList.innerHTML = '';

            const filteredFunctions = getFilteredFunctions();

            filteredFunctions.forEach(func => {
                const item = createFunctionListItem(func);
                functionList.appendChild(item);
            });
        }

        function createFunctionListItem(func) {
            const item = document.createElement('div');
            item.className = `function-item ${func.isLibrary ? 'library' : ''}`;
            item.dataset.functionId = func.id;

            item.innerHTML = `
                <div class="function-name">${func.name}</div>
                <div class="function-address">${func.address}</div>
                <div class="function-tags">
                    ${func.tags.map(tag => `<span class="tag ${getTagClass(tag)}">${tag}</span>`).join('')}
                </div>
            `;

            item.addEventListener('click', () => selectFunction(func));
            return item;
        }

        function getTagClass(tag) {
            if (tag.startsWith('GAME_LOGIC')) return 'game-logic';
            if (tag.startsWith('LIBRARY')) return 'library';
            if (tag.startsWith('UTILITY')) return 'utility';
            if (tag.startsWith('MOD')) return 'mod';
            return '';
        }

        function selectFunction(func) {
            currentData.selectedFunction = func;

            // Update UI selection
            document.querySelectorAll('.function-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-function-id="${func.id}"]`).classList.add('selected');

            // Update matrix highlighting
            updateMatrixHighlighting(func);
        }

        function renderMatrixTable() {
            const table = document.getElementById('matrixTable');
            const header = document.getElementById('matrixHeader');
            const body = document.getElementById('matrixBody');

            // Clear existing content
            header.innerHTML = '';
            body.innerHTML = '';

            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Function</th>';

            currentData.versions.forEach(version => {
                const th = document.createElement('th');
                th.textContent = `${version.family} ${version.version}`;
                th.className = version.version === currentData.selectedVersion ? 'selected-version' : '';
                headerRow.appendChild(th);
            });
            header.appendChild(headerRow);

            // Create function rows
            const filteredFunctions = getFilteredFunctions();
            filteredFunctions.forEach(func => {
                const row = createMatrixRow(func);
                body.appendChild(row);
            });
        }

        function createMatrixRow(func) {
            const row = document.createElement('tr');
            row.dataset.functionId = func.id;

            // Function name cell
            const nameCell = document.createElement('td');
            nameCell.textContent = func.name;
            nameCell.style.textAlign = 'left';
            nameCell.style.fontFamily = 'monospace';
            nameCell.style.fontSize = '11px';
            row.appendChild(nameCell);

            // Similarity cells for each version
            currentData.versions.forEach(version => {
                const cell = document.createElement('td');
                cell.className = version.version === currentData.selectedVersion ? 'selected-version' : '';

                const funcKey = `${func.name}@${func.address}`;
                const similarity = currentData.matrix[funcKey]?.[version.version];

                if (similarity) {
                    const scoreText = Math.round(similarity.score * 100) + '%';
                    cell.innerHTML = `<div class="similarity-cell ${similarity.matchType.toLowerCase()}-match">${scoreText}</div>`;
                    cell.title = `${similarity.matchType} match (${similarity.confidence} confidence)`;
                } else {
                    cell.innerHTML = '<div class="similarity-cell no-match">-</div>';
                }

                cell.addEventListener('click', () => onMatrixCellClick(func, version.version, cell));
                row.appendChild(cell);
            });

            return row;
        }

        function updateMatrixHighlighting(selectedFunc) {
            // Remove previous highlighting
            document.querySelectorAll('.matrix-table tr').forEach(row => {
                row.classList.remove('selected-row');
            });
            document.querySelectorAll('.matrix-table td').forEach(cell => {
                cell.classList.remove('bullseye');
            });

            // Add new highlighting
            const selectedRow = document.querySelector(`tr[data-function-id="${selectedFunc.id}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected-row');
            }
        }

        function onMatrixCellClick(func, targetVersion, cell) {
            // Remove previous bullseye
            document.querySelectorAll('.bullseye').forEach(el => el.classList.remove('bullseye'));

            // Add bullseye to clicked cell
            cell.classList.add('bullseye');

            currentData.selectedTargetAddress = targetVersion;

            // Show comparison panel
            showFunctionComparison(func, targetVersion);
        }

        function showFunctionComparison(sourceFunc, targetVersion) {
            const panel = document.getElementById('comparePanel');
            const content = document.getElementById('compareContent');

            // Mock comparison data
            const comparisonData = {
                sourceFunction: {
                    name: sourceFunc.name,
                    address: sourceFunc.address,
                    binary: currentData.selectedBinary,
                    version: currentData.selectedVersion,
                    instructionCount: 45,
                    complexity: sourceFunc.complexity
                },
                targetFunction: {
                    name: sourceFunc.name,
                    address: `0x${(parseInt(sourceFunc.address, 16) + 0x1000).toString(16).toUpperCase()}`,
                    binary: 'D2Game.dll',
                    version: targetVersion,
                    instructionCount: 52,
                    complexity: sourceFunc.complexity + 1
                },
                overallSimilarity: 0.84,
                matchType: 'SIMILAR',
                confidence: 'HIGH',
                signatureSimilarity: 1.0,
                structuralSimilarity: 0.78,
                semanticSimilarity: 0.82,
                tagSimilarity: 0.75
            };

            content.innerHTML = `
                <div class="function-comparison">
                    <div class="function-details">
                        <h4>Source Function</h4>
                        <div class="detail-item">
                            <span class="detail-label">Name:</span> ${comparisonData.sourceFunction.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Address:</span> ${comparisonData.sourceFunction.address}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Version:</span> ${comparisonData.sourceFunction.version}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Instructions:</span> ${comparisonData.sourceFunction.instructionCount}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Complexity:</span> ${comparisonData.sourceFunction.complexity}
                        </div>
                    </div>
                    <div class="function-details">
                        <h4>Target Function</h4>
                        <div class="detail-item">
                            <span class="detail-label">Name:</span> ${comparisonData.targetFunction.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Address:</span> ${comparisonData.targetFunction.address}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Version:</span> ${comparisonData.targetFunction.version}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Instructions:</span> ${comparisonData.targetFunction.instructionCount}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Complexity:</span> ${comparisonData.targetFunction.complexity}
                        </div>
                    </div>
                </div>
                <div class="similarity-metrics">
                    <h4>Similarity Analysis</h4>
                    <div class="metric-item">
                        <span>Overall Similarity:</span>
                        <span class="metric-score">${Math.round(comparisonData.overallSimilarity * 100)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>Signature Similarity:</span>
                        <span class="metric-score">${Math.round(comparisonData.signatureSimilarity * 100)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>Structural Similarity:</span>
                        <span class="metric-score">${Math.round(comparisonData.structuralSimilarity * 100)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>Semantic Similarity:</span>
                        <span class="metric-score">${Math.round(comparisonData.semanticSimilarity * 100)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>Tag Similarity:</span>
                        <span class="metric-score">${Math.round(comparisonData.tagSimilarity * 100)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>Match Type:</span>
                        <span class="metric-score">${comparisonData.matchType}</span>
                    </div>
                    <div class="metric-item">
                        <span>Confidence:</span>
                        <span class="metric-score">${comparisonData.confidence}</span>
                    </div>
                </div>
            `;

            panel.classList.add('visible');
        }

        function closeComparePanel() {
            document.getElementById('comparePanel').classList.remove('visible');

            // Remove bullseye highlighting
            document.querySelectorAll('.bullseye').forEach(el => el.classList.remove('bullseye'));
        }

        function getFilteredFunctions() {
            const filterText = document.getElementById('filterInput').value.toLowerCase();
            const tagFilter = document.getElementById('tagFilter').value;

            return currentData.functions.filter(func => {
                const matchesText = !filterText ||
                    func.name.toLowerCase().includes(filterText) ||
                    func.address.toLowerCase().includes(filterText);

                const matchesTag = !tagFilter ||
                    func.tags.some(tag => tag.startsWith(tagFilter));

                return matchesText && matchesTag;
            });
        }

        function onFilterChange() {
            if (currentData.functions.length > 0) {
                renderFunctionList();
                renderMatrixTable();
            }
        }

        function onTagFilterChange() {
            onFilterChange();
        }

        function clearFunctionList() {
            document.getElementById('functionList').innerHTML = '<div class="loading">Select a version and binary to load functions</div>';
            document.getElementById('matrixTable').getElementsByTagName('tbody')[0].innerHTML = '';
            document.getElementById('matrixTable').getElementsByTagName('thead')[0].innerHTML = '';
        }

        function showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
    </script>
</body>
</html>